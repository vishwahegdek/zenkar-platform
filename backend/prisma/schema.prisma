// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")

  customers      Customer[]
  contacts       Contact[] // Relation - user can own contacts
  // labourers Labourer[] // Removed for shared access
  recipients     Recipient[]
  financeParties FinanceParty[]
  auditLogs      AuditLog[]

  // Google Sync Credentials
  googleRefreshToken String?   @map("google_refresh_token")
  lastSyncAt         DateTime? @map("last_sync_at")

  createdOrders   Order[]   @relation("OrderCreatedBy")
  updatedOrders   Order[]   @relation("OrderUpdatedBy")
  createdPayments Payment[] @relation("PaymentCreatedBy")
  updatedPayments Payment[] @relation("PaymentUpdatedBy")
  createdExpenses Expense[] @relation("ExpenseCreatedBy")
  updatedExpenses Expense[] @relation("ExpenseUpdatedBy")
  createdProducts Product[] @relation("ProductCreatedBy")
  updatedProducts Product[] @relation("ProductUpdatedBy")
  createdPurchases Purchase[] @relation("PurchaseCreatedBy")
  updatedPurchases Purchase[] @relation("PurchaseUpdatedBy")

  @@map("users")
}

model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  address   String?
  createdAt DateTime @default(now()) @map("created_at")
  userId    Int?     @map("user_id")
  contactId Int?     @map("contact_id") // Optional link to Contact
  user      User?    @relation(fields: [userId], references: [id], onDelete: Restrict)
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: Restrict)
  orders    Order[]

  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at")

  @@map("customers")
}

model Image {
  id           Int    @id @default(autoincrement())
  keyRaw       String @map("key_raw")
  keyOptimized String @map("key_optimized")
  keyThumbnail String @map("key_thumbnail")

  productId   Int? @map("product_id")
  orderItemId Int? @map("order_item_id")

  product   Product?   @relation(fields: [productId], references: [id], onDelete: Restrict)
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("images")
}

model ProductCategory {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("product_categories")
}

model Product {
  id               Int     @id @default(autoincrement())
  name             String
  defaultUnitPrice Decimal @default(0) @map("default_unit_price") @db.Decimal(10, 2)
  notes            String?

  categoryId Int             @map("category_id") // Strict FK
  category   ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  createdById Int?        @map("created_by_id")
  updatedById Int?        @map("updated_by_id")
  createdBy   User?       @relation("ProductCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy   User?       @relation("ProductUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)
  images      Image[]
  createdAt   DateTime    @default(now()) @map("created_at")
  isDeleted   Boolean     @default(false) @map("is_deleted")
  deletedAt   DateTime?   @map("deleted_at")
  orderItems  OrderItem[]
  
  // Inventory
  isPurchasable      Boolean @default(false) @map("is_inventory_tracked")
  stockQuantity      Int     @default(0) @map("stock_quantity")
  purchaseItems      PurchaseItem[]
  inventoryTransactions InventoryTransaction[]

  @@map("products")
}

enum OrderStatus {
  ENQUIRED
  CONFIRMED
  CLOSED
  CANCELLED
  DELIVERED
}

enum DeliveryStatus {
  CONFIRMED
  IN_PRODUCTION
  READY
  PARTIALLY_DELIVERED
  FULLY_DELIVERED
}

enum ItemStatus {
  CONFIRMED
  IN_PRODUCTION
  READY
  DELIVERED
}

enum PaymentStatus {
  UNPAID
  PARTIALLY_PAID
  FULLY_PAID
}

model Order {
  id           Int       @id @default(autoincrement())
  orderNo      String?   @map("order_no")
  customerId   Int?      @map("customer_id")
  orderDate    DateTime  @default(now()) @map("order_date") @db.Date
  dueDate      DateTime? @map("due_date") @db.Date
  deliveryDate DateTime? @map("delivery_date") @db.Date

  status         OrderStatus     @default(CONFIRMED)
  deliveryStatus DeliveryStatus? @map("delivery_status")
  paymentStatus  PaymentStatus?  @map("payment_status")

  totalAmount Decimal   @default(0) @map("total_amount") @db.Decimal(12, 2)
  discount    Decimal   @default(0) @db.Decimal(12, 2)
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  isDeleted   Boolean   @default(false) @map("is_deleted")
  isQuickSale Boolean   @default(false) @map("is_quick_sale")
  deletedAt   DateTime? @map("deleted_at")

  customer   Customer?   @relation(fields: [customerId], references: [id], onDelete: Restrict)
  items      OrderItem[]
  payments   Payment[]
  gstInvoice GstInvoice?

  createdById Int?  @map("created_by_id")
  updatedById Int?  @map("updated_by_id")
  createdBy   User? @relation("OrderCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy   User? @relation("OrderUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)

  @@map("orders")
}

model GstInvoice {
  id           Int     @id @default(autoincrement())
  orderId      Int     @unique @map("order_id")
  invoiceNo    String  @map("invoice_no")
  customerName String  @map("customer_name")
  items        Json // Stores [{ productName, quantity, unitPrice, lineTotal }]
  subtotal     Decimal @db.Decimal(12, 2)
  discount     Decimal @default(0) @db.Decimal(12, 2)
  totalAmount  Decimal @map("total_amount") @db.Decimal(12, 2)

  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  createdAt DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("gst_invoices")
}

model Payment {
  id        Int      @id @default(autoincrement())
  orderId   Int      @map("order_id")
  amount    Decimal  @db.Decimal(12, 2)
  method    String   @default("CASH") // CASH, UPI
  date      DateTime @default(now()) @db.Date // Payment date
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdById Int?  @map("created_by_id")
  updatedById Int?  @map("updated_by_id")
  createdBy   User? @relation("PaymentCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy   User? @relation("PaymentUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)

  @@map("payments")
}

model OrderItem {
  id          Int        @id @default(autoincrement())
  orderId     Int?       @map("order_id")
  productId   Int?       @map("product_id")
  productName String?    @map("product_name")
  description String?
  status      ItemStatus @default(CONFIRMED)
  images      Image[]
  quantity    Decimal    @default(0) @db.Decimal(10, 2)
  unitPrice   Decimal    @default(0) @map("unit_price") @db.Decimal(10, 2)
  lineTotal   Decimal    @default(0) @map("line_total") @db.Decimal(12, 2)

  order   Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@map("order_items")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  action     String // CREATE, UPDATE, DELETE
  resource   String // Order, Product, Customer
  resourceId String // ID of the resource (stored as string for flexibility)
  details    Json? // Stores the changes or snapshot
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("audit_logs")
}

model ExpenseCategory {
  id   Int    @id @default(autoincrement())
  name String @unique

  expenses Expense[]

  @@map("expense_categories")
}

model Contact {
  id        Int      @id @default(autoincrement())
  userId    Int?     @map("user_id")
  name      String
  phone     String?
  group     String?
  googleId  String?  @map("google_id")
  createdAt DateTime @default(now()) @map("created_at")

  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at")

  user           User?          @relation(fields: [userId], references: [id], onDelete: Restrict)
  customers      Customer[]
  recipients     Recipient[]

  financeParties FinanceParty[]
  purchases      Purchase[]
  phones         ContactPhone[]

  @@map("contacts")
}

model ContactPhone {
  id        Int    @id @default(autoincrement())
  contactId Int    @map("contact_id")
  phone     String // E.164 format
  type      String @default("mobile") // mobile, home, work, etc.

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("contact_phones")
}

model Recipient {
  id        Int      @id @default(autoincrement())
  contactId Int?     @map("contact_id")
  userId    Int?     @map("user_id")
  name      String // Recipient Name (derived from contact or custom)
  createdAt DateTime @default(now()) @map("created_at")

  contact  Contact?  @relation(fields: [contactId], references: [id], onDelete: Restrict)
  user     User?     @relation(fields: [userId], references: [id], onDelete: Restrict)
  expenses Expense[]

  @@unique([userId, contactId, name]) // Flexible uniqueness
  @@map("recipients")
}

model Labourer {
  id               Int      @id @default(autoincrement())
  // userId    Int?     @map("user_id") // Removed for shared access
  name             String
  defaultDailyWage Decimal? @map("default_daily_wage") @db.Decimal(12, 2)
  isDeleted        Boolean  @default(false) @map("is_deleted")
  createdAt        DateTime @default(now()) @map("created_at")

  // userId    Int?     @map("user_id") // Removed for shared access
  attendance Attendance[]
  expenses   Expense[]

  settlements LabourSettlement[]

  @@map("labourers")
}

model LabourSettlement {
  id             Int      @id @default(autoincrement())
  labourerId     Int      @map("labourer_id")
  settlementDate DateTime @map("settlement_date") @db.Date

  // Snapshots at time of settlement
  totalAttendance Decimal @default(0) @map("total_attendance") @db.Decimal(10, 2)
  totalPayable    Decimal @default(0) @map("total_payable") @db.Decimal(12, 2)
  totalPaid       Decimal @default(0) @map("total_paid") @db.Decimal(12, 2)
  netBalance      Decimal @default(0) @map("net_balance") @db.Decimal(12, 2)
  wageSnapshot    Decimal @default(0) @map("wage_snapshot") @db.Decimal(10, 2)

  note           String?
  isCarryForward Boolean @default(false) @map("is_carry_forward")

  createdAt DateTime @default(now()) @map("created_at")

  labourer Labourer @relation(fields: [labourerId], references: [id], onDelete: Restrict)

  @@map("labour_settlements")
}

model Attendance {
  id         Int      @id @default(autoincrement())
  labourerId Int      @map("labourer_id")
  date       DateTime @db.Date
  value      Decimal  @db.Decimal(3, 1) // 0.5 or 1.0
  createdAt  DateTime @default(now()) @map("created_at")

  labourer Labourer @relation(fields: [labourerId], references: [id], onDelete: Restrict)

  @@unique([labourerId, date])
  @@map("attendance")
}

model Expense {
  id          Int  @id @default(autoincrement())
  categoryId  Int  @map("category_id")
  recipientId Int? @map("recipient_id") // Old: Link to Contact
  labourerId  Int? @map("labourer_id") // Link to Labourer

  recipientLinkId Int? @map("recipient_link_id") // New: Link to Recipient

  amount      Decimal  @db.Decimal(12, 2)
  date        DateTime @db.Date // Changed to date only
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  category  ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  recipient Recipient?      @relation(fields: [recipientId], references: [id], onDelete: Restrict)
  labourer  Labourer?       @relation(fields: [labourerId], references: [id], onDelete: Restrict)

  createdById Int?  @map("created_by_id")
  updatedById Int?  @map("updated_by_id")
  createdBy   User? @relation("ExpenseCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy   User? @relation("ExpenseUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)

  @@map("expenses")
}

model FinanceParty {
  id     Int     @id @default(autoincrement())
  userId Int?    @map("user_id")
  name   String?
  phone  String?
  notes  String?
  type   String  @default("CREDITOR") // CREDITOR (Payable), DEBTOR (Receivable) - Hints default view

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  contactId    Int?                 @map("contact_id")
  user         User?                @relation(fields: [userId], references: [id], onDelete: Restrict)
  contact      Contact?             @relation(fields: [contactId], references: [id], onDelete: Restrict)
  transactions FinanceTransaction[]

  @@map("finance_parties")
}

model FinanceTransaction {
  id             Int      @id @default(autoincrement())
  financePartyId Int      @map("finance_party_id")
  amount         Decimal  @db.Decimal(12, 2)
  type           String // BORROWED, REPAID, LENT, COLLECTED
  date           DateTime @db.Date
  note           String?
  createdAt      DateTime @default(now()) @map("created_at")

  party FinanceParty @relation(fields: [financePartyId], references: [id], onDelete: Cascade)

  @@map("finance_transactions")
}

model Purchase {
  id           Int       @id @default(autoincrement())
  supplierId   Int?      @map("supplier_id")
  purchaseDate DateTime  @default(now()) @map("purchase_date") @db.Date
  totalAmount  Decimal   @default(0) @map("total_amount") @db.Decimal(12, 2)
  notes        String?
  
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at")

  supplier     Contact?       @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  items        PurchaseItem[]
  
  createdById Int?  @map("created_by_id")
  updatedById Int?  @map("updated_by_id")
  createdBy   User? @relation("PurchaseCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy   User? @relation("PurchaseUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)

  @@map("purchases")
}

model PurchaseItem {
  id         Int      @id @default(autoincrement())
  purchaseId Int      @map("purchase_id")
  productId  Int      @map("product_id")
  quantity   Int
  unitCost   Decimal  @default(0) @map("unit_cost") @db.Decimal(10, 2)
  lineTotal  Decimal  @default(0) @map("line_total") @db.Decimal(12, 2)

  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@map("purchase_items")
}

enum InventoryTransactionType {
  PURCHASE
  SALE
  ADJUSTMENT
  PRODUCTION
}

model InventoryTransaction {
  id          Int      @id @default(autoincrement())
  productId   Int      @map("product_id")
  quantity    Int      // Positive for added, negative for removed
  type        InventoryTransactionType
  referenceId Int?     @map("reference_id") // OrderId, PurchaseId, etc.
  note        String?
  createdAt   DateTime @default(now()) @map("created_at")

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("inventory_transactions")
}
