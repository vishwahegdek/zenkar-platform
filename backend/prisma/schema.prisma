// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  
  customers Customer[]
  contacts  Contact[] // Relation - user can own contacts
  labourers Labourer[]
  recipients Recipient[]
  auditLogs AuditLog[]

  createdOrders   Order[]   @relation("OrderCreatedBy")
  updatedOrders   Order[]   @relation("OrderUpdatedBy")
  createdPayments Payment[] @relation("PaymentCreatedBy")
  updatedPayments Payment[] @relation("PaymentUpdatedBy")
  createdExpenses Expense[] @relation("ExpenseCreatedBy")
  updatedExpenses Expense[] @relation("ExpenseUpdatedBy")
  createdProducts Product[] @relation("ProductCreatedBy")
  updatedProducts Product[] @relation("ProductUpdatedBy")

  @@map("users")
}

model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  address   String?
  createdAt DateTime @default(now()) @map("created_at")
  userId    Int?     @map("user_id")
  contactId Int?     @map("contact_id") // Optional link to Contact
  user      User?    @relation(fields: [userId], references: [id])
  contact   Contact? @relation(fields: [contactId], references: [id])
  orders    Order[]

  @@map("customers")
}

model Image {
  id           Int      @id @default(autoincrement())
  keyRaw       String   @map("key_raw")
  keyOptimized String   @map("key_optimized")
  keyThumbnail String   @map("key_thumbnail")

  productId   Int?      @map("product_id")
  orderItemId Int?      @map("order_item_id")

  product     Product?  @relation(fields: [productId], references: [id])
  orderItem   OrderItem? @relation(fields: [orderItemId], references: [id])

  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("images")
}

model Product {
  id               Int         @id @default(autoincrement())
  name             String
  defaultUnitPrice Decimal     @default(0) @map("default_unit_price") @db.Decimal(10, 2)
  notes            String?

  createdById Int?     @map("created_by_id")
  updatedById Int?     @map("updated_by_id")
  createdBy   User?    @relation("ProductCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?    @relation("ProductUpdatedBy", fields: [updatedById], references: [id])
  images           Image[]
  createdAt        DateTime    @default(now()) @map("created_at")
  isDeleted        Boolean     @default(false) @map("is_deleted")
  deletedAt        DateTime?   @map("deleted_at")
  orderItems       OrderItem[]

  @@map("products")
}

model Order {
  id            Int         @id @default(autoincrement())
  orderNo       String?     @map("order_no")
  customerId    Int?        @map("customer_id")
  orderDate     DateTime    @default(now()) @map("order_date") @db.Date
  dueDate       DateTime?   @map("due_date") @db.Date
  deliveryDate  DateTime?   @map("delivery_date") @db.Date
  status        String      @default("confirmed") // enquired, confirmed, production, ready, delivered, cancelled
  totalAmount   Decimal     @default(0) @map("total_amount") @db.Decimal(12, 2)
  advanceAmount Decimal     @default(0) @map("advance_amount") @db.Decimal(12, 2)
  discount      Decimal     @default(0) @db.Decimal(12, 2)
  notes         String?
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @default(now()) @updatedAt @map("updated_at")
  isDeleted     Boolean     @default(false) @map("is_deleted")
  isQuickSale   Boolean     @default(false) @map("is_quick_sale")
  deletedAt     DateTime?   @map("deleted_at")

  customer      Customer?   @relation(fields: [customerId], references: [id])
  items         OrderItem[]
  payments      Payment[]

  createdById   Int?      @map("created_by_id")
  updatedById   Int?      @map("updated_by_id")
  createdBy     User?     @relation("OrderCreatedBy", fields: [createdById], references: [id])
  updatedBy     User?     @relation("OrderUpdatedBy", fields: [updatedById], references: [id])

  @@map("orders")
}

model Payment {
  id        Int      @id @default(autoincrement())
  orderId   Int      @map("order_id")
  amount    Decimal  @db.Decimal(12, 2)
  date      DateTime @default(now()) @db.Date // Payment date
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdById Int?     @map("created_by_id")
  updatedById Int?     @map("updated_by_id")
  createdBy   User?    @relation("PaymentCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?    @relation("PaymentUpdatedBy", fields: [updatedById], references: [id])

  @@map("payments")
}

model OrderItem {
  id          Int      @id @default(autoincrement())
  orderId     Int?     @map("order_id")
  productId   Int?     @map("product_id")
  productName String?  @map("product_name")
  description String?
  images      Image[]
  quantity    Decimal  @default(0) @db.Decimal(10, 2)
  unitPrice   Decimal  @default(0) @map("unit_price") @db.Decimal(10, 2)
  lineTotal   Decimal  @default(0) @map("line_total") @db.Decimal(12, 2)

  order       Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])

  @@map("order_items")
}


model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  action     String   // CREATE, UPDATE, DELETE
  resource   String   // Order, Product, Customer
  resourceId String   // ID of the resource (stored as string for flexibility)
  details    Json?    // Stores the changes or snapshot
  createdAt  DateTime @default(now()) @map("created_at")

  user       User?    @relation(fields: [userId], references: [id])


  @@map("audit_logs")
}



model ExpenseCategory {
  id    Int    @id @default(autoincrement())
  name  String @unique
  
  expenses Expense[]

  @@map("expense_categories")
}


model Contact {
  id        Int      @id @default(autoincrement())
  userId    Int?     @map("user_id") 
  name      String
  phone     String?
  group     String?  
  createdAt DateTime @default(now()) @map("created_at")

  user      User?    @relation(fields: [userId], references: [id])
  customers Customer[]
  recipients Recipient[]

  @@map("contacts")
}

model Recipient {
  id        Int      @id @default(autoincrement())
  contactId Int?     @map("contact_id")
  userId    Int?     @map("user_id") 
  name      String   // Recipient Name (derived from contact or custom)
  createdAt DateTime @default(now()) @map("created_at")

  contact   Contact? @relation(fields: [contactId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])
  expenses  Expense[]

  @@unique([userId, contactId, name]) // Flexible uniqueness
  @@map("recipients")
}

model Labourer {
  id        Int      @id @default(autoincrement())
  userId    Int?     @map("user_id")
  name      String
  defaultDailyWage Decimal? @map("default_daily_wage") @db.Decimal(12, 2)
  isDeleted Boolean  @default(false) @map("is_deleted")
  createdAt DateTime @default(now()) @map("created_at")

  user      User?    @relation(fields: [userId], references: [id])
  attendance Attendance[]
  expenses   Expense[]

  @@map("labourers")
}

model Attendance {
  id        Int      @id @default(autoincrement())
  labourerId Int     @map("labourer_id")
  date      DateTime @db.Date
  value     Decimal  @db.Decimal(3, 1) // 0.5 or 1.0
  createdAt DateTime @default(now()) @map("created_at")

  labourer  Labourer @relation(fields: [labourerId], references: [id])

  @@unique([labourerId, date])
  @@map("attendance")
}

model Expense {
  id          Int      @id @default(autoincrement())
  categoryId  Int      @map("category_id")
  recipientId Int?     @map("recipient_id") // Old: Link to Contact
  labourerId  Int?     @map("labourer_id")  // Link to Labourer
  
  recipientLinkId Int? @map("recipient_link_id") // New: Link to Recipient

  amount      Decimal  @db.Decimal(12, 2)
  date        DateTime @db.Date // Changed to date only
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  category    ExpenseCategory @relation(fields: [categoryId], references: [id])
  recipient   Recipient?      @relation(fields: [recipientId], references: [id])
  labourer    Labourer?       @relation(fields: [labourerId], references: [id])
  
  createdById Int?     @map("created_by_id")
  updatedById Int?     @map("updated_by_id")
  createdBy   User?    @relation("ExpenseCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?    @relation("ExpenseUpdatedBy", fields: [updatedById], references: [id])
  
  @@map("expenses")
}
